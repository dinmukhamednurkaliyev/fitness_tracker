name: "PR: Description"

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: "PR: Description"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;

            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner, repo, pull_number: pr.number
            });

            const formatCommit = (c) => {
              const shortSha = c.sha.substring(0, 7);
              const msg = c.commit.message.split('\n')[0];
              const url = c.html_url;
              return `<li><a href="${url}"><code>${shortSha}</code></a> ${msg}</li>`;
            };

            const groups = {
              feat: [],
              fix: [],
              chore: [],
              other: []
            };

            commits.forEach(c => {
              const msg = c.commit.message.toLowerCase();
              if (msg.startsWith('feat')) groups.feat.push(formatCommit(c));
              else if (msg.startsWith('fix')) groups.fix.push(formatCommit(c));
              else if (msg.startsWith('chore') || msg.startsWith('ci') || msg.startsWith('test')) groups.chore.push(formatCommit(c));
              else groups.other.push(formatCommit(c));
            });

            let htmlContent = '';

            if (groups.feat.length) htmlContent += `<h4>üöÄ Features</h4><ul>${groups.feat.join('')}</ul>`;
            if (groups.fix.length) htmlContent += `<h4>üêõ Bug Fixes</h4><ul>${groups.fix.join('')}</ul>`;
            if (groups.chore.length) htmlContent += `<h4>üîß Maintenance & Chore</h4><ul>${groups.chore.join('')}</ul>`;
            if (groups.other.length) htmlContent += `<h4>üì¶ Other Changes</h4><ul>${groups.other.join('')}</ul>`;

            const finalBlock = `
            <!-- START_AUTO_SECTION -->
            <details>
              <summary><strong>ü§ñ Auto-generated Summary</strong></summary>
              <br />
              ${htmlContent || '<em>No new commits found.</em>'}
              <p align="right"><small>Updated automatically by GitHub Actions</small></p>
            </details>
            <!-- END_AUTO_SECTION -->
            `;

            let body = pr.body || "";
            const regex = /<!-- START_AUTO_SECTION -->[\s\S]*<!-- END_AUTO_SECTION -->/;

            if (body.match(regex)) {
              body = body.replace(regex, finalBlock);
            } else {
              body = body + "\n\n" + finalBlock;
            }

            await github.rest.pulls.update({
              owner, repo, pull_number: pr.number, body: body
            });
